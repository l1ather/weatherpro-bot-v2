import logging
from aiogram import Router, F
from aiogram.filters import Command
from aiogram.types import Message, CallbackQuery

from services.weather_api import WeatherAPI, CityNotFoundError, APITimeoutError
from services.formatter import WeatherFormatter
from keyboards.inline import get_city_actions_keyboard
from keyboards.main import get_main_keyboard
from utils.validators import CityValidator
from database.models import init_db
from database.crud import UserCRUD, WeatherRequestCRUD, FavoriteCityCRUD

router = Router()
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
SessionLocal = init_db()


@router.message(Command("start"))
async def cmd_start(message: Message):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    session = SessionLocal()
    try:
        # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        UserCRUD.get_or_create(
            session,
            message.from_user.id,
            username=message.from_user.username,
            first_name=message.from_user.first_name,
            last_name=message.from_user.last_name,
            language_code=message.from_user.language_code
        )
        
        await message.answer(
            "üëã <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ WeatherPro Bot v2!</b>\n\n"
            "–Ø –ø–æ–º–æ–≥—É —É–∑–Ω–∞—Ç—å –ø–æ–≥–æ–¥—É –≤ –ª—é–±–æ–º –≥–æ—Ä–æ–¥–µ –º–∏—Ä–∞.\n\n"
            "<b>üåü –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</b>\n"
            "‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ - –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø\n"
            "üìä –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏\n"
            "üíæ –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤\n"
            "üé® –ö—Ä–∞—Å–∏–≤–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å emoji\n\n"
            "<b>–ß—Ç–æ —è —É–º–µ—é:</b>\n"
            "üå§ –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é –ø–æ–≥–æ–¥—É\n"
            "üìÖ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 5 –¥–Ω–µ–π\n"
            "üìç –ü–æ–≥–æ–¥—É –ø–æ –≤–∞—à–µ–π –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏\n"
            "‚≠ê –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞\n\n"
            "–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∏–∂–µ üëá",
            reply_markup=get_main_keyboard()
        )
    
    finally:
        session.close()


@router.message(F.text == "üå§ –ü–æ–≥–æ–¥–∞ —Å–µ–π—á–∞—Å")
async def request_current_weather(message: Message):
    """–ó–∞–ø—Ä–æ—Å —Ç–µ–∫—É—â–µ–π –ø–æ–≥–æ–¥—ã"""
    await message.answer(
        "üåç <b>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞</b>\n\n"
        "–í—ã –º–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º –∏–ª–∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ.\n\n"
        "<b>–ü—Ä–∏–º–µ—Ä—ã:</b>\n"
        "‚Ä¢ <code>–ú–æ—Å–∫–≤–∞</code>\n"
        "‚Ä¢ <code>–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥</code>\n"
        "‚Ä¢ <code>New York</code>\n"
        "‚Ä¢ <code>London, UK</code>\n\n"
        "üí° <i>–î–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Å—Ç—Ä–∞–Ω—É —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</i>"
    )


@router.message(F.text == "‚ÑπÔ∏è –ü–æ–º–æ—â—å")
async def cmd_help(message: Message):
    """–ö–æ–º–∞–Ω–¥–∞ –ø–æ–º–æ—â–∏"""
    await message.answer(
        "<b>üìñ –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é</b>\n\n"
        "<b>üå§ –¢–µ–∫—É—â–∞—è –ø–æ–≥–æ–¥–∞:</b>\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–≥–æ–¥–µ.\n\n"
        "<b>üìÖ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 5 –¥–Ω–µ–π:</b>\n"
        "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∏ –≤–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞.\n\n"
        "<b>üìç –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è:</b>\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é' –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–≥–æ–¥—ã –≤ –≤–∞—à–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏.\n\n"
        "<b>‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞:</b>\n"
        "–î–æ–±–∞–≤—å—Ç–µ –¥–æ 10 –ª—é–±–∏–º—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –∏—Ö –ø–æ–≥–æ–¥–µ.\n\n"
        "<b>üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</b>\n"
        "‚Ä¢ –£–º–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–≥–æ–¥–µ\n"
        "‚Ä¢ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤\n"
        "‚Ä¢ –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏, –≤–µ—Ç—Ä–µ, –¥–∞–≤–ª–µ–Ω–∏–∏\n"
        "‚Ä¢ –≠–º–æ–¥–∑–∏-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã\n\n"
        "<b>üéØ –ö–æ–º–∞–Ω–¥—ã:</b>\n"
        "/start - –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã\n"
        "/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
        "/favorites - –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞\n\n"
        "üíæ <i>–î–∞–Ω–Ω—ã–µ –∫–µ—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ 1 —á–∞—Å –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ API-–∑–∞–ø—Ä–æ—Å–æ–≤</i>"
    )


@router.message(F.text & ~F.text.startswith('/'))
async def get_weather_by_city(message: Message, cache):
    """–ü–æ–ª—É—á–∏—Ç—å –ø–æ–≥–æ–¥—É –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –≥–æ—Ä–æ–¥–∞"""
    city = message.text.strip()
    
    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
    menu_buttons = ["üå§ –ü–æ–≥–æ–¥–∞ —Å–µ–π—á–∞—Å", "üìÖ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 5 –¥–Ω–µ–π", "‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ", "‚ÑπÔ∏è –ü–æ–º–æ—â—å"]
    if city in menu_buttons:
        return
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –≥–æ—Ä–æ–¥–∞
    sanitized_city = CityValidator.sanitize(city)
    
    if not sanitized_city:
        error_msg = CityValidator.get_error_message(city)
        await message.answer(
            f"‚ùå <b>–û—à–∏–±–∫–∞ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –≥–æ—Ä–æ–¥–∞</b>\n\n"
            f"{error_msg}\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /help –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏"
        )
        return
    
    session = SessionLocal()
    status_msg = await message.answer("üîç –ò—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–≥–æ–¥–µ...")
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user = UserCRUD.get_or_create(
            session,
            message.from_user.id,
            username=message.from_user.username,
            first_name=message.from_user.first_name
        )
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–≥–æ–¥—É
        api = WeatherAPI(cache)
        weather = await api.get_current_weather(sanitized_city)
        
        # –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
        WeatherRequestCRUD.create(
            session,
            user.id,
            weather['city'],
            'current',
            success=True
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º –ª–∏ –≥–æ—Ä–æ–¥
        is_favorite = FavoriteCityCRUD.is_favorite(session, user.id, weather['city'])
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        text = WeatherFormatter.format_current_weather(weather)
        
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ç—É—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await status_msg.delete()
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        await message.answer(
            text,
            reply_markup=get_city_actions_keyboard(weather['city'], is_favorite)
        )
        
        logger.info(f"‚úÖ –ü–æ–≥–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: {weather['city']} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")
        
    except CityNotFoundError:
        await status_msg.edit_text(
            "‚ùå <b>–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω</b>\n\n"
            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
            "‚Ä¢ –£–∫–∞–∑–∞—Ç—å —Å—Ç—Ä–∞–Ω—É: <code>Springfield, US</code>\n"
            "‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ\n"
            "‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–µ—á–∞—Ç–∫–∏\n\n"
            "üí° –í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–≥–æ–¥—ã"
        )
        
        # –õ–æ–≥–∏—Ä—É–µ–º –Ω–µ—É–¥–∞—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å
        if session:
            user = UserCRUD.get_or_create(session, message.from_user.id)
            WeatherRequestCRUD.create(session, user.id, sanitized_city, 'current', success=False)
    
    except APITimeoutError:
        await status_msg.edit_text(
            "‚è± <b>–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è</b>\n\n"
            "–°–µ—Ä–≤–∏—Å –ø–æ–≥–æ–¥—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.\n\n"
            "üîÑ –ú—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä–∏–ª–∏ –∑–∞–ø—Ä–æ—Å 3 —Ä–∞–∑–∞"
        )
    
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–≥–æ–¥—ã: {e}", exc_info=True)
        await status_msg.edit_text(
            "üòî <b>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞</b>\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.\n"
            "–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
        )
    
    finally:
        session.close()


@router.callback_query(F.data.startswith("current:"))
async def callback_current_weather(callback: CallbackQuery, cache):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ callback –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –ø–æ–≥–æ–¥—ã"""
    city = callback.data.split(":", 1)[1]
    
    await callback.answer("üîÑ –û–±–Ω–æ–≤–ª—è—é –¥–∞–Ω–Ω—ã–µ...")
    
    session = SessionLocal()
    try:
        api = WeatherAPI(cache)
        
        # –£–¥–∞–ª—è–µ–º –∫–µ—à –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö
        cache_key = cache.make_key('weather', city)
        await cache.delete(cache_key)
        
        weather = await api.get_current_weather(city)
        
        # –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
        user = UserCRUD.get_or_create(session, callback.from_user.id)
        WeatherRequestCRUD.create(session, user.id, weather['city'], 'current', success=True)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
        is_favorite = FavoriteCityCRUD.is_favorite(session, user.id, weather['city'])
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        text = WeatherFormatter.format_current_weather(weather, from_cache=False)
        
        await callback.message.edit_text(
            text,
            reply_markup=get_city_actions_keyboard(weather['city'], is_favorite)
        )
        
        logger.info(f"üîÑ –ü–æ–≥–æ–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞: {weather['city']} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")
        
    except CityNotFoundError:
        await callback.answer("‚ùå –ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
    
    except APITimeoutError:
        await callback.answer("‚è± –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è", show_alert=True)
    
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–≥–æ–¥—ã: {e}", exc_info=True)
        await callback.answer("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è", show_alert=True)
    
    finally:
        session.close()


@router.message(Command("history"))
async def show_history(message: Message):
    """–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    session = SessionLocal()
    try:
        user = UserCRUD.get_or_create(session, message.from_user.id)
        history = WeatherRequestCRUD.get_user_history(session, user.id, limit=10)
        
        if not history:
            await message.answer(
                "üìã <b>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—É—Å—Ç–∞</b>\n\n"
                "–ù–∞—á–Ω–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é!"
            )
            return
        
        text = "üìã <b>–í–∞—à–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã:</b>\n\n"
        
        for i, request in enumerate(history, 1):
            status = "‚úÖ" if request.success else "‚ùå"
            date = request.created_at.strftime("%d.%m %H:%M")
            text += f"{i}. {status} {request.city_name} - {date}\n"
        
        await message.answer(text)
    
    finally:
        session.close()